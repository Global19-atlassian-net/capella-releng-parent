<?xml version="1.0" encoding="UTF-8"?>
<!--
  Copyright (c) 2020 THALES GLOBAL SERVICES.
  All rights reserved. This program and the accompanying materials
  are made available under the terms of the Eclipse Public License v1.0
  which accompanies this distribution, and is available at
  http://www.eclipse.org/legal/epl-v10.html

  Contributors:
       Thales - initial API and implementation
-->
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	 xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
  <modelVersion>4.0.0</modelVersion>

  <parent>
    <groupId>org.polarsys</groupId>
    <artifactId>capella-addon</artifactId>
    <version>1.4.1-SNAPSHOT</version>
    <relativePath>capella-addon.xml</relativePath>
  </parent>

  <name>Capella Addon Site Parent</name>
  <artifactId>capella-addon-site</artifactId>
  <packaging>pom</packaging>
  
  <properties>
    <!-- basename for dropins zip file -->
    <packagedSiteName>${project.artifactId}</packagedSiteName>
  </properties>


  <!-- this profile auto-activates if this is really an update site artifact.
       I don't want to run the plugins below when *this* pom itself is deployed -->
  <profiles>
    <profile>
      <id>zip-repo-and-make-dropins</id>
      <activation>
	<file>
	  <exists>
	    category.xml
	  </exists>
	</file>
      </activation>
      <build>
	<plugins>
	  <!-- FIXME why even need this? why not zip the repo directly... -->
	  <plugin>
	    <groupId>org.eclipse.tycho.extras</groupId>
	    <artifactId>tycho-eclipserun-plugin</artifactId>
	    <version>${tycho-extras-version}</version>
	    <configuration>
	      <repositories>
		<repository>
		  <id>eclipse-repo</id>
		  <layout>p2</layout>
		  <url>${eclipse-repo.url}</url>
		</repository>
	      </repositories>
	      <dependencies>
		<dependency>
		  <artifactId>org.eclipse.equinox.p2.repository.tools</artifactId>
		  <type>eclipse-plugin</type>
		</dependency>
		<dependency>
		  <artifactId>org.eclipse.equinox.p2.core.feature</artifactId>
		  <type>eclipse-feature</type>
		</dependency>
		<dependency>
		  <artifactId>org.eclipse.equinox.p2.extras.feature</artifactId>
		  <type>eclipse-feature</type>
		</dependency>
		<dependency>
		  <artifactId>org.eclipse.equinox.ds</artifactId>
		  <type>eclipse-plugin</type>
		</dependency>
	      </dependencies>
	      <executionEnvironment>JavaSE-1.8</executionEnvironment>
	    </configuration>
	    <executions>
	      <execution>
		<id>create-dropins</id>
		<phase>package</phase>
		<goals>
		  <goal>eclipse-run</goal>
		</goals>
		<configuration>
		  <appArgLine>-application org.eclipse.equinox.p2.repository.repo2runnable -source file:"${project.build.directory}/repository" -destination "${project.build.directory}/${packagedSiteName}/eclipse"</appArgLine>
		</configuration>
	      </execution>
	    </executions>
	  </plugin>
	  <plugin>
	    <groupId>org.apache.maven.plugins</groupId>
	    <artifactId>maven-antrun-plugin</artifactId>
	    <version>${antrun-version}</version>
	    <executions>
	      <execution>
		<id>package-dropins</id>
		<phase>package</phase>
		<goals>
		  <goal>run</goal>
		</goals>
		<configuration>
		  <target>
		    <delete
			file="${project.build.directory}/${packagedSiteName}/eclipse/artifacts.jar" />
		    <delete
			file="${project.build.directory}/${packagedSiteName}/eclipse/content.jar" />
		    <delete includeemptydirs="true">
		      <fileset
			  dir="${project.build.directory}/${packagedSiteName}/eclipse/features"
			  includes="**/META-INF/**" />
		    </delete>
		    <zip
			destfile="${project.build.directory}/${packagedSiteName}-dropins-${unqualifiedVersion}.${buildQualifier}.zip">
		      <fileset dir="${project.build.directory}">
			<include name="${packagedSiteName}/**" />
		      </fileset>
		    </zip>
		  </target>
		</configuration>
	      </execution>
	    </executions>
	  </plugin>
	  <plugin>
	    <groupId>org.eclipse.tycho</groupId>
	    <artifactId>tycho-p2-repository-plugin</artifactId>
	    <version>${tycho-version}</version>
	    <configuration>
		<finalName>${packagedSiteName}-site-${unqualifiedVersion}.${buildQualifier}</finalName>
	    </configuration>
	  </plugin>
	</plugins>
      </build>
    </profile>
  </profiles>
</project>
